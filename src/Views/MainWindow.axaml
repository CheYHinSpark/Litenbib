<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:v="using:Litenbib.Views"
        xmlns:vm="using:Litenbib.ViewModels"
        xmlns:m="using:Litenbib.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="720"
        Name="LitbibMainWindow"
        x:Class="Litenbib.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/logo.ico"
        Title="Litenbib">
    <Window.Resources>
        <m:FilterModeConverter x:Key="FilterModeConverter"/>
        <m:MultiObjectEqualConverter x:Key="MultiObjectEqualConverter"/>
        <m:WindowStateToPathConverter x:Key="WindowStateToPathConverter"/>
    </Window.Resources>

    <Window.KeyBindings>
        <KeyBinding Command="{CompiledBinding NewFileCommand}" Gesture="Ctrl+N"
                    CommandParameter="{CompiledBinding #LitbibMainWindow}"/>
        <KeyBinding Command="{CompiledBinding AddBibtexEntryCommand}" Gesture="Ctrl+Shift+A"
                    CommandParameter="{CompiledBinding #LitbibMainWindow}"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.CopyBibtexCommand}" Gesture="Ctrl+C"
                    CommandParameter="{CompiledBinding #LitbibMainWindow.DataContext}"/>
		<KeyBinding Command="{CompiledBinding SelectedFile.PasteBibtexCommand}" Gesture="Ctrl+V"
                    CommandParameter="{CompiledBinding #LitbibMainWindow.DataContext}"/>
		<KeyBinding Command="{CompiledBinding SelectedFile.CutBibtexCommand}" Gesture="Ctrl+X"
                    CommandParameter="{CompiledBinding #LitbibMainWindow.DataContext}"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.UndoBibtexCommand}" Gesture="Ctrl+Z"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.RedoBibtexCommand}" Gesture="Ctrl+Y"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.DeleteBibtexKeyCommand}" Gesture="Delete"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.SaveBibtexCommand}" Gesture="Ctrl+S"/>
    </Window.KeyBindings>

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid Name="RootGrid" RowDefinitions="Auto,*">
        <Rectangle HorizontalAlignment="Stretch"
                   VerticalAlignment="Stretch"
                   Fill="{DynamicResource MainBackground}"
                   PointerPressed="TitleBar_PointerPressed"
                   PointerReleased="TitleBar_PointerReleased"/>
        
        <Grid Name="TitleBarGrid" ColumnDefinitions="*,*,*"
              RowDefinitions="Auto,Auto">
            <Border Grid.Column="1" Grid.RowSpan="2" CornerRadius="0 0 12 12"
                    Margin="0 0 0 2"
                    Background="{DynamicResource TabBackground}" Classes="hide_show">
                <Border.IsEnabled>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="#FilterTextBox.Text" Converter="{x:Static StringConverters.IsNotNullOrEmpty}}" />
                        <Binding Path="SelectedFile" Converter="{x:Static ObjectConverters.IsNotNull}" />
                    </MultiBinding>
                </Border.IsEnabled>
                <Grid ColumnDefinitions="*,*,*,2*" Margin="4"
                      Height="{DynamicResource ToolBarHeight}"
                      VerticalAlignment="Bottom">
                    <RadioButton IsChecked="{CompiledBinding SelectedFile.FilterMode,
                                 Converter={StaticResource FilterModeConverter},
                                 Mode=TwoWay, ConverterParameter=0, FallbackValue=True}"
                                 GroupName="FilterMode" Margin="4">and</RadioButton>
                    <RadioButton IsChecked="{CompiledBinding SelectedFile.FilterMode,
                                 Converter={StaticResource FilterModeConverter},
                                 Mode=OneWayToSource, ConverterParameter=1}"
                                 GroupName="FilterMode" Margin="4" Grid.Column="1">or</RadioButton>
                    <RadioButton IsChecked="{CompiledBinding SelectedFile.FilterMode,
                                 Converter={StaticResource FilterModeConverter},
                                 Mode=OneWayToSource, ConverterParameter=2}"
                                 GroupName="FilterMode" Margin="4" Grid.Column="2">all</RadioButton>
                    <v:ExComboBox Margin="4" Grid.Column="3"
                                  CornerRadius="12" Padding="12 0"
                                  SelectedItem="{CompiledBinding SelectedFile.FilterField,
                                  Mode=OneWayToSource}" SelectedIndex="0"
                                  ItemsSource="{CompiledBinding FilterFieldList}"/>
                </Grid>
            </Border>
            <TextBox x:Name="FilterTextBox" Grid.Column="1" Grid.RowSpan="2" UndoLimit="200"
                     m:FocusEx.IsFocused="{CompiledBinding SelectedFile.IsFiltering, Mode=OneWayToSource}"
                     Text="{CompiledBinding SelectedFile.FilterText, Mode=OneWayToSource}"
                     Watermark="Search..."
                     VerticalAlignment="Top" Margin="8 6"/>

            <!--title-->
            <StackPanel Orientation="Horizontal" VerticalAlignment="Top">
                <Menu>
                    <MenuItem Header="_File" Classes="Top">
                        <MenuItem Header="_New"
                                  Command="{CompiledBinding NewFileCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window]}"/>
                        <MenuItem Header="_Open..."
                                  Command="{CompiledBinding OpenFileCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window]}"/>
                        <MenuItem Header="_Export"
                                  Command="{CompiledBinding ExportFileCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window]}"/>
                        <MenuItem Header="_Save All"
                                  Command="{CompiledBinding SaveAllCommand}"/>
                    </MenuItem>
                    <MenuItem Header="_Edit" Classes="Top">
                        <MenuItem Header="_Add..."
                                  Command="{CompiledBinding AddBibtexEntryCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window]}"/>
                        <MenuItem Header="_Copy"
                                  Command="{CompiledBinding SelectedFile.CopyBibtexCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window].DataContext}"/>
						<MenuItem Header="_Paste"
                                  Command="{CompiledBinding SelectedFile.PasteBibtexCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window].DataContext}"/>
						<MenuItem Header="_Cut"
                                  Command="{CompiledBinding SelectedFile.CutBibtexCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window].DataContext}"/>
                    </MenuItem>
                </Menu>
            </StackPanel>
            
            <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" Grid.Column="2">
				<Button Classes="window" Command="{CompiledBinding ChangeThemeCommand}">
					<Grid>
						<Path Data="{StaticResource SunPath}" StrokeThickness="1"
                              Stroke="{CompiledBinding $parent[Button].Foreground}"
                              Fill="{CompiledBinding $parent[Button].Foreground}"
							  IsVisible="{CompiledBinding ThemeIndex}"/>
						<Path Data="{StaticResource MoonPath}"
                              Fill="{CompiledBinding $parent[Button].Foreground}"
							  IsVisible="{CompiledBinding ThemeIndex, Converter={x:Static BoolConverters.Not}}"/>
					</Grid>
				</Button>
                <Button Name="MinButton" Click="TitleButton_Click" Classes="window">
                    <Path Data="{StaticResource -Path}" StrokeThickness="1"
                          Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                </Button>
                <Button Name="MaxButton" Click="TitleButton_Click" Classes="window">
                    <Path Data="{CompiledBinding $parent[Window].WindowState, Converter={StaticResource WindowStateToPathConverter}}"
                          StrokeThickness="1" Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                </Button>
                <Button Name="CloseButton" Click="TitleButton_Click" Classes="warning window">
                    <Path Data="{StaticResource xPath}" StrokeThickness="1"
                          Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                </Button>
            </StackPanel>

            <!--tool-->
            <Grid Grid.Row="1" Height="{StaticResource TitleBarHeight}"
                  Grid.ColumnSpan="3"
                  Opacity="{CompiledBinding ShowToolBar}">
                <Grid.Styles>
                    <Style Selector="Button">
                        <Setter Property="Background" Value="{DynamicResource InputBackground}"/>
                        <Setter Property="Width" Value="28"/>
						<Setter Property="Height" Value="28"/>
						<Setter Property="Margin" Value="0 2"/>
                    </Style>
                </Grid.Styles>
                <Border Margin="8 0" Background="{DynamicResource InputBackground}"
                        HorizontalAlignment="Left" VerticalAlignment="Center"
						BorderBrush="{DynamicResource MainBorder}"
						BorderThickness="1"
                        CornerRadius="8">
                    <StackPanel Orientation="Horizontal" Margin="6 0" VerticalAlignment="Center">
                        <Button Command="{CompiledBinding SelectedFile.UndoBibtexCommand}">
                            <Path Data="{StaticResource UndoPath}" StrokeThickness="1"
                                  Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                        <Button Command="{CompiledBinding SelectedFile.RedoBibtexCommand}">
                            <Path Data="{StaticResource RedoPath}" StrokeThickness="1"
                                  Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                        <Button Command="{CompiledBinding SelectedFile.DeleteBibtexCommand}">
                            <Path Data="{StaticResource DeletePath}"
                                  Fill="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                        <Button Command="{CompiledBinding SelectedFile.SaveBibtexCommand}">
                            <Path Data="{StaticResource SavePath}" StrokeThickness="1"
                                  Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                        <Button Command="{CompiledBinding AddBibtexEntryCommand}"
                                CommandParameter="{CompiledBinding $parent[Window]}">
                            <Path Data="{StaticResource AddPath}"
                                  Fill="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                        <Button Command="{CompiledBinding SelectedFile.MergeEntriesCommand}"
                                CommandParameter="{CompiledBinding $parent[Window]}">
                            <Path Data="{StaticResource MergePath}" StrokeThickness="1"
                                  Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                    </StackPanel>
                </Border>
                <Border Margin="8 0" Background="{DynamicResource InputBackground}"
                        HorizontalAlignment="Right" VerticalAlignment="Center"
						BorderBrush="{DynamicResource MainBorder}"
						BorderThickness="1"
                        CornerRadius="8">
                    <StackPanel Orientation="Horizontal" Margin="6 0" VerticalAlignment="Center">
                        <Button Command="{CompiledBinding OpenWebsiteCommand}"
                                CommandParameter="https://dblp.org/">
                            <Viewbox Margin="2">
                                <Svg Path="/Assets/dblp.svg"/>
                            </Viewbox>
                        </Button>
                        <Button Command="{CompiledBinding OpenWebsiteCommand}"
                                CommandParameter="https://arxiv.org/">
                            <Viewbox Margin="2">
                                <Svg Path="/Assets/arxiv.svg"/>
                            </Viewbox>
                        </Button>
                        <Button Command="{CompiledBinding OpenWebsiteCommand}"
                                CommandParameter="https://www.semanticscholar.org/">
                            <Viewbox Margin="1">
                                <Svg Path="/Assets/semantic_scholar.svg"/>
                            </Viewbox>
                        </Button>
                        <Button Command="{CompiledBinding OpenWebsiteCommand}"
                                CommandParameter="https://www.researchgate.net/">
                            <Viewbox Margin="2">
                                <Svg Path="/Assets/researchgate.svg"/>
                            </Viewbox>
                        </Button>
                        <Button Command="{CompiledBinding OpenWebsiteCommand}"
                                CommandParameter="https://scholar.google.com/">
                            <Viewbox Margin="3">
                                <Svg Path="/Assets/google_scholar.svg"/>
                            </Viewbox>
                        </Button>
                        <Button Command="{CompiledBinding OpenWebsiteCommand}"
                                CommandParameter="https://openreview.net/">
                            <Viewbox Margin="0">
                                <Svg Path="/Assets/openreview.svg"/>
                            </Viewbox>
                        </Button>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>  
        
        <!--content-->
        <Grid x:Name="MainTabControl" Grid.Row="1" RowDefinitions="Auto,*"
			  Background="{DynamicResource MainBackground}"
              PointerMoved="TabControl_PointerMoved"
			  DragDrop.AllowDrop="True">
			<!--welcome-->
			<StackPanel Grid.RowSpan="2" VerticalAlignment="Center">
				<Svg Path="/Assets/logo.svg" Width="100"/>
				<TextBlock Text="Welcome to LitenBib"
						   HorizontalAlignment="Center"
						   FontSize="24"/>
			</StackPanel>

            <!--tabcontrol-->
			<TabStrip x:Name="MainTabStrip" ItemsSource="{CompiledBinding BibtexTabs}"
                      SelectedItem="{CompiledBinding SelectedFile}">
                <TabStrip.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Grid.Column="1" Orientation="Horizontal"
                                PointerPressed="TabItem_PointerPressed"
                                PointerReleased="TabItem_PointerReleased">
                            <TextBlock Text="*" FontSize="{CompiledBinding $parent[Window].FontSize}"
                                       IsVisible="{CompiledBinding Edited}" Margin="4 0 0 0"/>
                            <TextBlock Text="{CompiledBinding Header}" Margin="4 0"
                                       VerticalAlignment="Center"
                                       FontSize="{CompiledBinding $parent[Window].FontSize}"/>
                            <Button Classes="tab_button warning"
                                    FontSize="{CompiledBinding $parent[Window].FontSize}"
                                    Command="{CompiledBinding #LitbibMainWindow.DataContext.CloseTabCommand}"
                                    CommandParameter="{CompiledBinding}">
                                <Path Data="{StaticResource xPath}" StrokeThickness="1"
                                      HorizontalAlignment="Stretch"
                                      VerticalAlignment="Stretch"
                                      Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                            </Button>
                        </StackPanel>
                    </DataTemplate>
                </TabStrip.ItemTemplate>
            </TabStrip>
            <ItemsControl Grid.Row="1" ItemsSource="{CompiledBinding BibtexTabs}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Grid />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:BibtexViewModel">
                        <ContentPresenter Content="{Binding .}">
                            <ContentPresenter.IsVisible>
                                <MultiBinding Converter="{StaticResource MultiObjectEqualConverter}">
                                    <Binding Path="#LitbibMainWindow.DataContext.SelectedFile"/>
                                    <Binding Path="."/>
                                </MultiBinding>
                            </ContentPresenter.IsVisible>
                        </ContentPresenter>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

			<!--dragdrop-->
			<Border Name="DragBorder" Grid.RowSpan="2"
					IsHitTestVisible="False"
					BorderBrush="{DynamicResource ThemeBorder}"
					Background="{DynamicResource InputBackground}"
					BorderThickness="4" CornerRadius="8" Margin="2"
					Opacity="0"/>
        </Grid>
    
	</Grid>
</Window>
