<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:v="using:Litenbib.Views"
        xmlns:vm="using:Litenbib.ViewModels"
        xmlns:m="using:Litenbib.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="720"
        Name="LitbibMainWindow"
        x:Class="Litenbib.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/logo.ico"
        Title="Litenbib">
    <Window.Resources>
        <m:FilterModeConverter x:Key="FilterModeConverter"/>
        <m:WindowStateToPathConverter x:Key="WindowStateToPathConverter"/>
    </Window.Resources>

    <Window.KeyBindings>
        <KeyBinding Command="{CompiledBinding NewFileCommand}" Gesture="Ctrl+N"
                    CommandParameter="{CompiledBinding #LitbibMainWindow}"/>
        <KeyBinding Command="{CompiledBinding AddBibtexEntryCommand}" Gesture="Ctrl+Shift+A"
                    CommandParameter="{CompiledBinding #LitbibMainWindow}"/>
		<KeyBinding Command="{CompiledBinding SelectedFile.CopyBibtexCommand}" Gesture="Ctrl+C"
					CommandParameter="{CompiledBinding #LitbibMainWindow.DataContext}"/>
		<KeyBinding Command="{CompiledBinding SelectedFile.PasteBibtexCommand}" Gesture="Ctrl+V"
					CommandParameter="{CompiledBinding #LitbibMainWindow.DataContext}"/>
		<KeyBinding Command="{CompiledBinding SelectedFile.UndoBibtexCommand}" Gesture="Ctrl+Z"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.RedoBibtexCommand}" Gesture="Ctrl+Y"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.DeleteBibtexKeyCommand}" Gesture="Delete"/>
        <KeyBinding Command="{CompiledBinding SelectedFile.SaveBibtexCommand}" Gesture="Ctrl+S"/>
    </Window.KeyBindings>

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid Name="RootGrid" RowDefinitions="Auto,*">
        <Rectangle HorizontalAlignment="Stretch"
                   VerticalAlignment="Stretch"
                   Fill="{DynamicResource MainBackground}"
                   PointerPressed="TitleBar_PointerPressed"
                   PointerReleased="TitleBar_PointerReleased"/>
        
        <Grid Name="TitleBarGrid" ColumnDefinitions="*,*,*"
              RowDefinitions="Auto,Auto">
            <Border Grid.Column="1" Grid.RowSpan="2" CornerRadius="0 0 12 12"
                    Background="{DynamicResource TabBackground}" Classes="hide_show">
                <Border.IsEnabled>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="#FilterTextBox.Text" Converter="{x:Static StringConverters.IsNotNullOrEmpty}}" />
                        <Binding Path="SelectedFile" Converter="{x:Static ObjectConverters.IsNotNull}" />
                    </MultiBinding>
                </Border.IsEnabled>
                <Grid ColumnDefinitions="*,*,*,2*" Margin="4 2"
                      Height="{DynamicResource ToolBarHeight}"
                      VerticalAlignment="Bottom">
                    <RadioButton IsChecked="{CompiledBinding SelectedFile.FilterMode,
                                 Converter={StaticResource FilterModeConverter},
                                 Mode=TwoWay, ConverterParameter=0, FallbackValue=True}"
                                 GroupName="FilterMode" Margin="4">and</RadioButton>
                    <RadioButton IsChecked="{CompiledBinding SelectedFile.FilterMode,
                                 Converter={StaticResource FilterModeConverter},
                                 Mode=OneWayToSource, ConverterParameter=1}"
                                 GroupName="FilterMode" Margin="4" Grid.Column="1">or</RadioButton>
                    <RadioButton IsChecked="{CompiledBinding SelectedFile.FilterMode,
                                 Converter={StaticResource FilterModeConverter},
                                 Mode=OneWayToSource, ConverterParameter=2}"
                                 GroupName="FilterMode" Margin="4" Grid.Column="2">all</RadioButton>
                    <v:ExComboBox Margin="4" Grid.Column="3"
                                  CornerRadius="12" Padding="12 0"
                                  SelectedItem="{CompiledBinding SelectedFile.FilterField,
                                  Mode=OneWayToSource}" SelectedIndex="0"
                                  ItemsSource="{CompiledBinding FilterFieldList}"/>
                </Grid>
            </Border>
            <TextBox x:Name="FilterTextBox" Grid.Column="1" Grid.RowSpan="2" UndoLimit="200"
                     m:FocusEx.IsFocused="{CompiledBinding SelectedFile.IsFiltering, Mode=OneWayToSource}"
                     Text="{CompiledBinding SelectedFile.FilterText, Mode=OneWayToSource}"
                     Watermark="Search or add..."
                     VerticalAlignment="Top" Margin="8 6"/>

            <!--title-->
            <StackPanel Orientation="Horizontal" VerticalAlignment="Top">
                <Menu>
                    <MenuItem Header="_File" Classes="Top">
                        <MenuItem Header="_New"
                                  Command="{CompiledBinding NewFileCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window]}"/>
                        <MenuItem Header="_Open..."
                                  Command="{CompiledBinding OpenFileCommand}"
                                  CommandParameter="{CompiledBinding $parent[Window]}"/>
                        <MenuItem Header="_Save All"
                                  Command="{CompiledBinding SaveAllCommand}">
                        </MenuItem>
                    </MenuItem>
					<MenuItem Header="_Edit" Classes="Top">
						<MenuItem Header="_Add..."
								  Command="{CompiledBinding AddBibtexEntryCommand}"
								  CommandParameter="{CompiledBinding $parent[Window]}"/>
						<MenuItem Header="_Copy"
								  Command="{CompiledBinding SelectedFile.CopyBibtexCommand}"
								  CommandParameter="{CompiledBinding $parent[Window].DataContext}"/>
						<MenuItem Header="_Paste"
								  Command="{CompiledBinding SelectedFile.PasteBibtexCommand}"
								  CommandParameter="{CompiledBinding $parent[Window].DataContext}"/>
					</MenuItem>
                </Menu>
            </StackPanel>
            
            <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" Grid.Column="2">
                <Button Name="MinButton" Click="TitleButton_Click" Classes="window">
                    <Path Data="{StaticResource -Path}" StrokeThickness="1"
                          Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                </Button>
                <Button Name="MaxButton" Click="TitleButton_Click" Classes="window">
                    <Path Data="{CompiledBinding $parent[Window].WindowState, Converter={StaticResource WindowStateToPathConverter}}"
                          StrokeThickness="1" Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                </Button>
                <Button Name="CloseButton" Click="TitleButton_Click" Classes="warning window">
                    <Path Data="{StaticResource xPath}" StrokeThickness="1"
                          Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                </Button>
            </StackPanel>

            <!--tool-->
            <Grid Grid.Row="1" Height="{StaticResource TitleBarHeight}"
                  Opacity="{Binding ShowToolBar}">
                <StackPanel Orientation="Horizontal" Margin="4 0">
                    <Button Width="28" Height="28"
                            Command="{CompiledBinding SelectedFile.UndoBibtexCommand}">
                        <Path Data="{StaticResource UndoPath}" StrokeThickness="1"
                              Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                    </Button>
                    <Button Width="28" Height="28"
                            Command="{CompiledBinding SelectedFile.RedoBibtexCommand}">
                        <Path Data="{StaticResource RedoPath}" StrokeThickness="1"
                              Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                    </Button>
                    <Button Width="28" Height="28"
                            Command="{CompiledBinding SelectedFile.DeleteBibtexCommand}">
                        <Path Data="{StaticResource DeletePath}"
                              Fill="{CompiledBinding $parent[Button].Foreground}"/>
                    </Button>
                    <Button Width="28" Height="28"
                            Command="{CompiledBinding SelectedFile.SaveBibtexCommand}">
                        <Path Data="{StaticResource SavePath}"
                              Fill="{CompiledBinding $parent[Button].Foreground}"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Grid>
        
        
        <!--welcome-->
        <StackPanel Grid.RowSpan="2" VerticalAlignment="Center">
            <Image Source="/Assets/logo.ico" Width="100"/>
            <TextBlock Text="Welcome to LitenBib"
                       HorizontalAlignment="Center"
                       FontSize="24"/>
        </StackPanel>

        <!--content-->
        <TabControl Grid.Row="1" Padding="0"
                    ItemsSource="{CompiledBinding BibtexViewers}"
                    SelectedItem="{CompiledBinding SelectedFile}">
            <!-- Tab Header -->
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <TextBlock Text="*" FontSize="{CompiledBinding $parent[Window].FontSize}"
                                   IsVisible="{CompiledBinding Edited}" Margin="4 0 0 0"/>
                        <TextBlock Text="{CompiledBinding Header}" Margin="4 0"
                                   VerticalAlignment="Center"
                                   FontSize="{CompiledBinding $parent[Window].FontSize}"/>
                        <Button Classes="tab_button warning"
                                FontSize="{CompiledBinding $parent[Window].FontSize}"
                                Command="{CompiledBinding #LitbibMainWindow.DataContext.CloseTabCommand}"
                                CommandParameter="{CompiledBinding}">
                            <Path Data="{StaticResource xPath}" StrokeThickness="1"
                                  Stroke="{CompiledBinding $parent[Button].Foreground}"/>
                        </Button>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>

            <!-- Tab 内容 -->
            <TabControl.ContentTemplate>
                <DataTemplate>
                    <TransitioningContentControl Content="{CompiledBinding}">
                        <TransitioningContentControl.PageTransition>
                            <CrossFade Duration="0:0:0.4"/>
                        </TransitioningContentControl.PageTransition>
                    </TransitioningContentControl>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </Grid>
</Window>
